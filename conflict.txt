Changes from branch 4 + 5
